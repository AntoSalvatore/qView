parameters:
- name: arch
  type: string
  default: 'win64_msvc2017_64'

steps:
- bash: |
    git clone https://github.com/Skycoder42/QtApng
    cd QtApng
    git checkout $(git tag | tail -1)
  displayName: Clone APNG plugin
  
- bash: |
    cd QtApng
    qmake "CONFIG += libpng_static"
    make
    sudo make install
  condition: and(succeeded(), ne( variables['Agent.OS'], 'Windows_NT' ))
  displayName: Build APNG plugin (Unix)

- script: |
    cd QtApng
    set "arch=${{ parameters.arch }}"
    call "%programfiles(x86)%\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars%arch:~3,2%.bat"
    qmake "CONFIG += libpng_static"
    nmake
  condition: and(succeeded(), eq( variables['Agent.OS'], 'Windows_NT' ))
  displayName: Build APNG plugin (Windows)

- bash: |
    git clone https://github.com/novomesk/qt-avif-image-plugin
    cd qt-avif-image-plugin
    git checkout $(git tag | tail -1)
  displayName: Clone AVIF plugin

- bash: |
    cd qt-avif-image-plugin
    ./build_libqavif_static.sh
    make
    sudo make install
  condition: and(succeeded(), ne( variables['Agent.OS'], 'Windows_NT' ))
  displayName: Build AVIF plugin (Unix)

- script: |
    set "arch=${{ parameters.arch }}"
    call "%programfiles(x86)%\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars%arch:~3,2%.bat"
    choco install yasm
    cd qt-avif-image-plugin/ext/libavif/ext/aom
    mkdir build.libavif
    cd build.libavif
    cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_DOCS=0 -DENABLE_EXAMPLES=0 -DENABLE_TESTDATA=0 -DENABLE_TESTS=0 -DENABLE_TOOLS=0 -DCONFIG_PIC=1 ..
    ninja
    copy aom.lib libaom.a
    cd ..\..\..\
    mkdir build
    cd build
    cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DAVIF_CODEC_AOM=ON -DAVIF_LOCAL_AOM=ON ..
    ninja
    copy avif.lib libavif.a
    cd ..\..\..\
    qmake qt-avif-image-plugin_local-libavif.pro
    nmake
  condition: and(succeeded(), eq( variables['Agent.OS'], 'Windows_NT' ))
  displayName: Build AVIF plugin (Windows)

  # Skip HEIF on mac because Qt supports HEIF on mac for some reason
- script: |
    git clone https://github.com/strukturag/libde265
    cd libde265
    git checkout $(git tag | tail -1)
    ./build.bat

    git clone https://github.com/strukturag/libheif
    git checkout $(git tag | tail -1)
    cd libheif
    cmake -DLIBDE265_LIBRARY="..\bin_%arch:~3,2%\lib\libde265.lib" -DLIBDE265_INCLUDE_DIR="..\bin_%arch:~3,2%\lib\" .
    nmake
    sudo make install
    
    git clone https://github.com/jakar/qt-heif-image-plugin
    git checkout $(git tag | tail -1)
    cd qt-heif-image-plugin
    cmake .
    make
    sudo make install
  condition: and(succeeded(), eq( variables['Agent.OS'], 'Windows_NT' ))
  displayName: Build HEIF plugin (Windows)

- bash: |
    git clone https://github.com/strukturag/libde265
    cd libde265
    git checkout $(git tag | tail -1)
    ./autogen.sh
    ./configure --disable-sherlock265
    make
    sudo make install

    git clone https://github.com/strukturag/libheif
    git checkout $(git tag | tail -1)
    cd libheif
    ./autogen.sh
    ./configure
    make
    sudo make install
    
    git clone https://github.com/jakar/qt-heif-image-plugin
    git checkout $(git tag | tail -1)
    cd qt-heif-image-plugin
    cmake .
    make
    sudo make install
  condition: and(succeeded(), eq( variables['Agent.OS'], 'Linux' ))
  displayName: Build HEIF plugin (Linux)

  # gtk2 and qt5ct style plugins for linux appimages
- bash: |
    git clone https://code.qt.io/qt/qtstyleplugins.git
    cd qtstyleplugins
    qmake
    sudo make install

    wget 'https://sourceforge.net/projects/qt5ct/files/latest/download'
    tar xf download
    cd qt5ct*
    qmake
    sudo make install
  condition: eq( variables['Agent.OS'], 'Linux' )
  displayName: Get GTK+2 and qt5ct styles